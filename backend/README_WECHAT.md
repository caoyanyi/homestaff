# 微信公众号集成指南

本文档提供了将家政AI知识库系统与微信公众号集成的详细步骤和配置说明。

## 功能概述

通过微信公众号集成，您可以：

- 允许微信用户直接与AI助手进行对话
- 自动保存微信用户的聊天记录
- 支持关注/取消关注等事件处理
- 为不同微信用户维护独立的会话状态

## 准备工作

在开始集成之前，您需要：

1. 拥有一个微信公众号（服务号或订阅号）
2. 完成公众号的开发者认证
3. 获取以下信息：
   - AppID
   - AppSecret
   - 设置服务器URL、Token和EncodingAESKey

## 配置步骤

### 1. 配置环境变量

复制`.env.example`文件中的微信相关配置到您的`.env`文件中，并填入实际值：

```
# 微信公众号配置
WECHAT_APPID=您的微信公众号AppID
WECHAT_APPSECRET=您的微信公众号AppSecret
WECHAT_TOKEN=自定义的Token（与微信公众号后台设置一致）
WECHAT_ENCODING_AES_KEY=自定义的EncodingAESKey（与微信公众号后台设置一致）
```

### 2. 数据库迁移

运行数据库迁移，创建微信用户表和修改聊天日志表：

```bash
php artisan migrate
```

### 3. 配置微信公众号服务器

1. 登录微信公众平台（https://mp.weixin.qq.com/）
2. 进入「开发」->「基本配置」页面
3. 启用服务器配置
4. 填写以下信息：
   - **服务器地址(URL)**：`http://您的服务器域名/api/wechat`
   - **令牌(Token)**：与`.env`文件中的`WECHAT_TOKEN`保持一致
   - **消息加解密密钥(EncodingAESKey)**：点击随机生成，然后复制到`.env`文件中
   - **消息加解密方式**：选择「安全模式」或「兼容模式」
5. 点击「提交」按钮，系统会自动验证服务器地址

### 4. 配置IP白名单

在微信公众平台的「开发」->「基本配置」页面，配置服务器IP白名单，将您的服务器IP添加进去，否则无法调用微信API。

## 使用说明

### 用户交互流程

1. 用户关注公众号后，会收到欢迎消息
2. 用户发送文本消息，系统会将消息转发给AI服务
3. AI生成回答后，通过公众号返回给用户
4. 所有对话历史都会被保存到数据库中

### 消息处理

系统目前支持以下消息类型：

- 文本消息：直接转发给AI服务处理
- 关注事件：发送欢迎消息并记录用户信息
- 取消关注事件：更新用户状态

## 常见问题

### 1. 服务器验证失败

- 检查URL是否正确（必须是公开可访问的域名）
- 确保Token与微信公众号后台设置一致
- 检查服务器防火墙配置，确保80/443端口开放

### 2. 消息发送失败

- 检查AppID和AppSecret是否正确
- 确认服务器IP已添加到白名单
- 查看日志文件，排查具体错误信息

### 3. 回答内容格式问题

- 微信消息有长度限制（最多2048字节），过长的回答会被截断
- 系统会自动清理不适合微信消息格式的字符

## 扩展开发

如果您需要扩展微信消息处理功能，可以修改`WeChatController.php`文件：

- 添加新的消息类型处理方法
- 增强事件处理逻辑
- 集成更多微信API功能

## 注意事项

1. 请确保服务器能够稳定运行，避免频繁宕机
2. 注意消息回复的时效性（微信要求5秒内响应）
3. 对于复杂问题，可以考虑使用异步处理方式
4. 定期清理过期的会话缓存和不活跃用户数据

## 技术支持

如有任何问题，请联系系统管理员或开发团队。