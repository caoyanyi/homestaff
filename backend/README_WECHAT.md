# 微信公众号接入说明（明文模式）

本文档提供了将家政AI知识库系统与微信公众号以明文模式集成的详细步骤和配置说明。

## 功能概述

通过微信公众号集成，您可以：

- 允许微信用户直接与AI助手进行对话
- 自动保存微信用户的聊天记录
- 支持关注/取消关注等事件处理
- 为不同微信用户维护独立的会话状态
- 使用明文模式进行简单快速的开发和调试

## 准备工作

在开始集成之前，您需要：

1. 拥有一个微信公众号（服务号或订阅号）
2. 完成公众号的开发者认证
3. PHP环境
4. 获取以下信息：
   - AppID
   - 设置服务器URL和Token

## 配置步骤

### 1. 配置环境变量

复制`.env.example`文件中的微信相关配置到您的`.env`文件中，并填入实际值：

```
# 微信公众号配置（明文模式）
WECHAT_APPID=您的微信公众号AppID
WECHAT_TOKEN=自定义的Token（与微信公众号后台设置一致）
```

### 2. 数据库迁移

运行数据库迁移，创建微信用户表和修改聊天日志表：

```bash
php artisan migrate
```

### 3. 配置微信公众号服务器

1. 登录微信公众平台（https://mp.weixin.qq.com/）
2. 进入「开发」->「基本配置」页面
3. 启用服务器配置
4. 填写以下信息：
   - **服务器地址(URL)**：`http://您的服务器域名/api/wechat`
   - **令牌(Token)**：与`.env`文件中的`WECHAT_TOKEN`保持一致
   - **消息加解密方式**：选择「明文模式」
5. 点击「提交」按钮，系统会自动验证服务器地址

### 4. 本地开发调试（可选）

如果您需要在本地进行开发调试，可以使用ngrok等工具进行内网穿透：

```bash
ngrok http 8000
```

然后将微信公众号的服务器地址配置为ngrok提供的公网地址：

```
https://你的ngrok地址/api/wechat
```

并启动本地开发服务器：

```bash
php artisan serve
```

## 使用说明

### 用户交互流程

1. 用户关注公众号后，会收到欢迎消息
2. 用户发送文本消息，系统会将消息转发给AI服务
3. AI生成回答后，通过公众号返回给用户
4. 所有对话历史都会被保存到数据库中

### 消息处理

系统目前支持以下消息类型：

- 文本消息：直接转发给AI服务处理
- 关注事件：发送欢迎消息并记录用户信息
- 取消关注事件：更新用户状态

## 常见问题

### 1. 服务器验证失败

- 检查URL是否正确（必须是公开可访问的域名）
- 确保Token与微信公众号后台设置一致
- 检查服务器防火墙配置，确保80/443端口开放
- 确认消息加解密方式已设置为「明文模式」

### 2. 消息处理异常

- 检查AppID是否正确
- 查看日志文件，排查具体错误信息
- 验证消息格式是否符合微信公众平台规范

### 3. 回答内容格式问题

- 微信消息有长度限制（最多2048字节），过长的回答会被截断
- 系统会自动清理不适合微信消息格式的字符

## 扩展开发

如果您需要扩展微信消息处理功能，可以修改`WeChatController.php`文件：

- 添加新的消息类型处理方法
- 增强事件处理逻辑
- 集成更多微信API功能

## 注意事项

1. 明文模式适合开发环境使用，配置简单，调试方便
2. 请确保服务器能够稳定运行，避免频繁宕机
3. 注意消息回复的时效性（微信要求5秒内响应）
4. 对于复杂问题，可以考虑使用异步处理方式
5. 定期清理过期的会话缓存和不活跃用户数据
6. 生产环境建议切换到安全模式以提高安全性

## 技术支持

如有任何问题，请联系系统管理员或开发团队。